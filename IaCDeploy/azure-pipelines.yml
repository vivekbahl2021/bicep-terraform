# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

pool:
  vmImage: ubuntu-latest

parameters:
  - name: RG
    default: rsgbcp606
    type: string
    values:
      - "rsgbcp606"
      - "rsgbcp705"
  - name: environment
    displayName: "Environment"
    default: "dev"
    type: string
    values:
      - "dev"
      - "test"
      - "prod"
  - name: sequenceNumber
    displayName: "Sequence number to use in resource naming"
    default: '01'
  
      
#variables:
#  RG: 'rsgbcp605'

jobs:
  - job: Deploy
    variables:
    - template: "${{parameters.environment}}/pipelineparams.${{parameters.environment}}.yaml"
    - name: bicepFilePath
      value: "$(Build.SourcesDirectory)/IaCDeploy/main.bicep"

    steps:
      - task: AzureCLI@2
        inputs:
          azureSubscription: 'Azure subscription 1 (d6015563-af1d-45a6-98c1-5c3169cb9573)'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          inlineScript: |
            # Read the byte array from a file (replace with your own method)
            $byteArray = [System.IO.File]::ReadAllBytes("$(Build.SourcesDirectory)/IaCDeploy/portalazure.cer")
            
            # Convert the byte array to a Base64-encoded string
            $base64String = [System.Convert]::ToBase64String($byteArray)
            #Write-Host "##vso[task.setvariable variable=$base64String] $env:certificateContent"
            $contet = $base64String
      - task: AzureCLI@2
        inputs:
            azureSubscription: 'Azure subscription 1 (d6015563-af1d-45a6-98c1-5c3169cb9573)'
            scriptType: 'pscore'
            scriptLocation: 'inlineScript'
            inlineScript: 'Write-Host "Snd time : $contet"'  
      
      - task: AzureResourceManagerTemplateDeployment@3
        displayName: 'Deploy Bicep Files'
        inputs:
          deploymentScope: 'Resource Group'
          azureResourceManagerConnection: 'Azure subscription 1(d6015563-af1d-45a6-98c1-5c3169cb9573)'
          subscriptionId: 'd6015563-af1d-45a6-98c1-5c3169cb9573'
          action: 'Create Or Update Resource Group'
          resourceGroupName: ${{parameters.RG}}
          location: 'East US'
          #templateLocation: 'Linked artifact'
          csmFile: ${{variables.bicepFilePath}}
          deploymentOutputs: deploymentOutputs
          overrideParameters: -certificateContent "$contet"
